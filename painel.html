<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input { display: block; margin-bottom: 10px; padding: 8px; width: 100%; max-width: 300px; }
        .item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .btn { padding: 8px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .msg-vazia { color: #888; font-style: italic; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>GestÃ£o de Doces</h2>
    <input type="text" id="nome" placeholder="Nome do Produto">
    <input type="number" id="preco" step="0.01" placeholder="PreÃ§o">
    <input type="number" id="estoque" placeholder="Estoque">
    <button class="btn" style="background:#ff85a1; color:#fff;" id="btnSalvar">Salvar Produto</button>

    <hr>
    <h3>Estoque Atual</h3>
    <div id="lista-estoque">Buscando...</div>

    <hr>
    <h3>Pedidos Pendentes</h3>
    <div id="lista-pedidos">Buscando...</div>

    <button onclick="logout()" style="margin-top:20px;">Sair</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6FUb-KoF6S4h-y70trrcElPb2AYuUogM",
            authDomain: "tia-do-doce.firebaseapp.com",
            projectId: "tia-do-doce",
            storageBucket: "tia-do-doce.firebasestorage.app",
            messagingSenderId: "766286783719",
            appId: "1:766286783719:web:f49c11f7190c88cc44ae42"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMINS = ["carlos.sabino@outlook.com.br", "lialmeyda@hotmail.com"];

        onAuthStateChanged(auth, (u) => {
            if (u && ADMINS.includes(u.email)) { iniciarEscutas(); } 
            else { window.location.href = "index.html"; }
        });

        window.logout = () => signOut(auth);

        function iniciarEscutas() {
            // Estoque
            onSnapshot(collection(db, "produtos"), (snap) => {
                const cont = document.getElementById('lista-estoque');
                if(snap.empty) { cont.innerHTML = "<p class='msg-vazia'>Estoque vazio.</p>"; return; }
                cont.innerHTML = "";
                snap.forEach(d => {
                    const i = d.data();
                    const ativo = i.ativo !== false;
                    cont.innerHTML += `
                        <div class="item" style="opacity:${ativo?1:0.4}">
                            <strong>${i.nome}</strong> - R$ ${i.preco.toFixed(2)} (${i.estoque} un)
                            <button class="btn" style="background:${ativo?'#e67e22':'#25d366'}; color:#fff; float:right;" 
                                onclick="toggleStatus('${d.id}', ${ativo})">${ativo?'Inativar':'Ativar'}</button>
                        </div>`;
                });
            });

            // Pedidos
            onSnapshot(query(collection(db, "pedidos"), where("status", "==", "Pendente")), (snap) => {
                const cont = document.getElementById('lista-pedidos');
                if(snap.empty) { cont.innerHTML = "<p class='msg-vazia'>Nenhum pedido pendente. ðŸ™Œ</p>"; return; }
                cont.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    cont.innerHTML += `
                        <div class="item">
                            ðŸ‘¤ ${p.cliente} | ðŸ’° R$ ${p.total.toFixed(2)}<br>
                            <button class="btn" style="background:#25d366; color:#fff;" onclick="updateStatus('${d.id}', 'Pago')">Pago</button>
                            <button class="btn" style="background:#ff7675; color:#fff;" onclick="updateStatus('${d.id}', 'Cancelado')">X</button>
                        </div>`;
                });
            });
        }

        window.toggleStatus = async (id, s) => { await updateDoc(doc(db, "produtos", id), { ativo: !s }); };
        window.updateStatus = async (id, s) => { await updateDoc(doc(db, "pedidos", id), { status: s }); };

        document.getElementById('btnSalvar').onclick = async () => {
            const n = document.getElementById('nome').value.toUpperCase().trim();
            const p = parseFloat(document.getElementById('preco').value);
            const e = parseInt(document.getElementById('estoque').value);
            if(!n || isNaN(p)) return alert("Preencha Nome e PreÃ§o!");

            const refFoto = await getDoc(doc(db, "config_fotos", n));
            const ext = refFoto.exists() ? refFoto.data().ext : ".webp";
            const arquivo = n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '') + ext;
           

            await addDoc(collection(db, "produtos"), { nome: n, preco: p, estoque: e || 0, fotoUrl: arquivo, ativo: true });
            alert("Salvo!");
        };
        window.db = db;
    </script>
</body>
</html>
